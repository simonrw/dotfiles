#!/usr/bin/env -S uv run --script
# vim: ft=python
"""Helper script to craft GH PR messages in a persistent file."""

from __future__ import annotations

import argparse
import os
import shutil
import subprocess
import sys
from pathlib import Path

MESSAGE_FILE = Path.home() / ".local" / "share" / "create-pr" / "gh_pr_message.md"


def ensure_message_file(path: Path) -> None:
    path.parent.mkdir(parents=True, exist_ok=True)
    if not path.exists():
        path.touch()


def resolve_editor() -> list[str]:
    for key in ("VISUAL", "EDITOR"):
        value = os.environ.get(key)
        if value:
            return value.split()
    if shutil.which("nano"):
        return ["nano"]
    return ["vi"]


def open_editor(path: Path) -> None:
    editor_cmd = resolve_editor() + [str(path)]
    try:
        subprocess.run(editor_cmd, check=True)
    except FileNotFoundError as exc:
        raise SystemExit(f"Editor command not found: {editor_cmd[0]}") from exc
    except subprocess.CalledProcessError as exc:
        raise SystemExit(exc.returncode)


def run_gh(args: list[str], message_file: Path) -> int:
    if any(arg in {"-F", "--body-file"} for arg in args):
        raise SystemExit("Do not supply -F/--body-file; the script manages it.")

    cmd = ["gh", "pr", "create", *args, "-F", str(message_file)]
    completed = subprocess.run(cmd)
    return completed.returncode


def main(argv: list[str]) -> int:
    ns = argparse.ArgumentParser(
        description=(
            "Open an editor for a persistent PR message body, then call "
            "`gh pr create` with that body file. Remaining arguments are "
            "passed directly to the GitHub CLI command."
        ),
        add_help=True,
        allow_abbrev=False,
    )
    args, gh_args = ns.parse_known_args(argv)

    ensure_message_file(MESSAGE_FILE)
    open_editor(MESSAGE_FILE)

    return run_gh(gh_args, MESSAGE_FILE)


if __name__ == "__main__":
    sys.exit(main(sys.argv[1:]))
