#!/usr/bin/env python3

import subprocess as sp
from typing import Protocol
from pathlib import Path
from enum import Enum, auto
from configparser import ConfigParser
from concurrent.futures import ThreadPoolExecutor, as_completed
from platform import platform


class Theme(Enum):
    dark = auto()
    light = auto()


class ThemeSwitcher(Protocol):
    def __call__(self, theme: Theme) -> None: ...


def current_theme() -> Theme:
    import sys

    # MacOS: use 'defaults'
    if sys.platform == "darwin":
        try:
            output = sp.check_output(
                ["defaults", "read", "NSGlobalDomain", "AppleInterfaceStyle"]
            )
            if output.decode().strip().lower() == "dark":
                return Theme.dark
        except sp.CalledProcessError:
            # If the key doesn't exist or light mode is set, treat as light
            return Theme.light
        return Theme.light

    # Ubuntu with GNOME: check gsettings color-scheme
    if sys.platform.startswith("linux"):
        try:
            output = sp.check_output(
                [
                    "gsettings",
                    "get",
                    "org.gnome.desktop.interface",
                    "color-scheme",
                ]
            )
            val = output.decode().strip().lower().replace("'", "")
            # Possible values: 'default', 'prefer-dark', 'prefer-light'
            if "dark" in val:
                return Theme.dark
            if "light" in val:
                return Theme.light
        except (sp.CalledProcessError, FileNotFoundError):
            # gsettings not present, or schema not available
            pass

        # Fallback: try gtk-theme, which may end in '-dark', commonly
        try:
            output = sp.check_output(
                [
                    "gsettings",
                    "get",
                    "org.gnome.desktop.interface",
                    "gtk-theme",
                ]
            )
            val = output.decode().strip().lower().replace("'", "")
            if val.endswith("-dark") or "dark" in val:
                return Theme.dark
        except (sp.CalledProcessError, FileNotFoundError):
            pass
        return Theme.light

    # Fallback to dark by default
    return Theme.dark


def reload_tmux(theme: Theme):
    sp.check_call(
        ["tmux", "source-file", str(Path.home() / ".config" / "tmux" / "tmux.conf")]
    )


def signal_editor_to_reload(*process_names: str):
    for process_name in process_names:
        try:
            raw_output = sp.check_output(["pgrep", process_name])
        except sp.CalledProcessError:
            return

    pids = [line.strip() for line in raw_output.decode().splitlines()]
    cmd = ["kill", "-USR1"] + pids
    sp.check_call(cmd)


def reload_helix(theme: Theme):
    theme_file = Path.home() / ".config" / "helix" / "themes" / "adaptive.toml"
    chosen_theme = "catppuccin_mocha"
    if theme == Theme.light:
        chosen_theme = "onelight"

    with theme_file.open("w") as outfile:
        print(f"inherits = '{chosen_theme}'", file=outfile)

    signal_editor_to_reload("hx")


def reload_neovim(theme: Theme):
    signal_editor_to_reload("nvim")


def reload_git(theme: Theme):
    theme_file = Path.home() / ".config" / "git" / "theme.conf"
    config = ConfigParser()
    if theme == Theme.light:
        syntax_theme = "GitHub"
        dark = "false"
        light = "true"
    else:
        syntax_theme = "Catppuccin Mocha"
        dark = "true"
        light = "false"

    config["delta"] = {
        "diff-so-fancy": "false" if theme == Theme.light else "true",
        "syntax-theme": syntax_theme,
        "dark": dark,
        "light": light,
        "line-numbers": "false",
        "side-by-side": "false",
    }
    with theme_file.open("w") as outfile:
        config.write(outfile)


def reload_gh_dash(theme: Theme):
    config_path = Path.home() / ".config" / "gh-dash"
    config_file = config_path / "config.yml"
    config_base = config_path / "config-base.yml"
    if theme == Theme.light:
        theme_file = config_path / "config-light.yml"
    else:
        theme_file = config_path / "config-dark.yml"

    with config_file.open("w") as outfile:
        with config_base.open("r") as infile:
            outfile.write(infile.read())
        with theme_file.open("r") as infile:
            outfile.write(infile.read())


theme = current_theme()

switchers: list[ThemeSwitcher] = [
    reload_tmux,
    reload_helix,
    reload_neovim,
    reload_git,
    reload_gh_dash,
]

with ThreadPoolExecutor() as pool:
    futs = []
    for fn in switchers:
        futs.append(pool.submit(fn, theme))

    for fut in as_completed(futs):
        fut.result()
