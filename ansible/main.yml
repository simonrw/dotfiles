---
- name: Install dependencies
  hosts: localhost
  vars_files:
    - packages.yml
    - vars.yml
  tasks:

    - name: Verify become password
      become: true
      ansible.builtin.command: /bin/true
      changed_when: false

    - name: Set user variable
      set_fact:
        ansible_target_user: "{{ lookup('env', 'USER') | default('simon', true) }}"

    - name: Configure user
      become: true
      ansible.builtin.user:
        name: "{{ ansible_target_user }}"
        groups: adm,cdrom,sudo,dip,plugdev,users,lpadmin,docker,kvm,libvirt,sudo
        shell: /usr/bin/fish

    - name: Ensure /etc/apt/keyrings directory exists
      become: true
      file:
        path: /etc/apt/keyrings
        state: directory
        mode: '0755'

    - name: Add APT keys
      become: true
      get_url:
        url: "{{ item.url }}"
        dest: "{{ item.keyring }}"
        mode: '0644'
      loop: "{{ apt_keys | default([]) }}"

    - name: Add APT repositories
      become: true
      apt_repository:
        repo: "{{ item.repo }}"
        filename: "{{ item.filename }}"
        state: present
      loop: "{{ apt_repositories | default([]) }}"

    - name: Setup 1Password CLI
      ansible.builtin.include_tasks: 1password.yml

    - name: Install packages
      become: true
      apt:
        name: "{{ packages }}"
        state: present
        update_cache: yes

    - name: Configure unattended-upgrades
      become: true
      ansible.builtin.copy:
        dest: /etc/apt/apt.conf.d/20auto-upgrades
        content: |
          APT::Periodic::Update-Package-Lists "1";
          APT::Periodic::Unattended-Upgrade "1";

    - name: Install snaps
      become: true
      community.general.snap:
        name: "{{ snaps }}"

    - name: Install classic snaps
      become: true
      community.general.snap:
        name: "{{ item }}"
        classic: true
      loop: "{{ classic_snaps | default([]) }}"

    - name: Create ~/.local/bin
      ansible.builtin.file:
        dest: "/home/{{ ansible_target_user }}/.local/bin"
        state: directory
        owner: "{{ ansible_target_user }}"
        group: "{{ ansible_target_user }}"

    - name: Create fd symlink
      ansible.builtin.file:
        src: /usr/bin/fdfind
        dest: "/home/{{ ansible_target_user }}/.local/bin/fd"
        state: link

    - name: Download ghostty .deb
      ansible.builtin.get_url:
        url: "https://github.com/mkasberg/ghostty-ubuntu/releases/download/{{ ghostty_version }}-ppa1/ghostty_{{ ghostty_version }}.ppa1_amd64_24.04.deb"
        dest: /tmp/ghostty_{{ ghostty_version }}.ppa1_amd64_24.04.deb

    - name: Install ghostty deb
      become: yes
      ansible.builtin.apt:
        deb: /tmp/ghostty_{{ ghostty_version }}.ppa1_amd64_24.04.deb

    - name: Download NoMachine .deb
      ansible.builtin.get_url:
        url: "https://download.nomachine.com/download/{{ nomachine_version.split('.')[:2] | join('.') }}/Linux/nomachine_{{ nomachine_version }}_1_amd64.deb"
        dest: /tmp/nomachine_{{ nomachine_version }}_1_amd64.deb

    - name: Install NoMachine deb
      become: yes
      ansible.builtin.apt:
        deb: /tmp/nomachine_{{ nomachine_version }}_1_amd64.deb

    - name: Download Sunshine .deb
      ansible.builtin.get_url:
        url: "https://github.com/LizardByte/Sunshine/releases/download/v{{ sunshine_version }}/sunshine-ubuntu-24.04-amd64.deb"
        dest: /tmp/sunshine-ubuntu-24.04-amd64.deb

    - name: Install Sunshine deb
      become: yes
      ansible.builtin.apt:
        deb: /tmp/sunshine-ubuntu-24.04-amd64.deb

    - name: Download Helium browser AppImage
      ansible.builtin.get_url:
        url: "https://github.com/imputnet/helium-linux/releases/download/{{ helium_version }}/helium-{{ helium_version }}-x86_64.AppImage"
        dest: "/usr/local/bin/helium"
        mode: "0755"
      become: true

    - name: Ensure icon directory exists
      become: true
      ansible.builtin.file:
        path: /usr/local/share/icons/hicolor/scalable/apps
        state: directory
        mode: "0755"

    - name: Download Helium browser icon
      become: true
      ansible.builtin.get_url:
        url: "https://raw.githubusercontent.com/imputnet/helium/main/resources/branding/product_logo.svg"
        dest: /usr/local/share/icons/hicolor/scalable/apps/helium.svg
        mode: "0644"

    - name: Install Helium AppArmor profile
      become: true
      ansible.builtin.copy:
        dest: /etc/apparmor.d/helium-appimage
        mode: "0644"
        content: |
          abi <abi/4.0>,
          include <tunables/global>

          profile helium-appimage "/usr/local/bin/helium" flags=(default_allow) {
            userns,
            include if exists <local/helium-appimage>
          }
      notify: Load Helium AppArmor profile

    - name: Install Lilex font
      ansible.builtin.include_tasks: font.yml
      vars:
        font_name: Lilex
        font_url: "https://github.com/mishamyrt/Lilex/releases/download/{{ lilex_version }}/Lilex.zip"

    - name: Install Ollama
      ansible.builtin.include_tasks: ollama.yml
      when: ansible_hostname == 'astoria'

    - name: Apply dconf settings
      community.general.dconf:
        key: "{{ item.key }}"
        value: "{{ item.value }}"
        state: present
      loop: "{{ dconf_settings | default([]) }}"

    - name: Download zed installer
      ansible.builtin.get_url:
        url: https://zed.dev/install.sh
        dest: /tmp/zed-install.sh

    - name: Install zed
      ansible.builtin.command: sh /tmp/zed-install.sh
      args:
        creates: "/home/{{ ansible_target_user }}/.local/bin/zed"

    - name: Enable x11vnc systemd user service
      ansible.builtin.systemd:
        name: x11vnc.service
        enabled: true
        scope: user
        daemon_reload: true

  handlers:
    - name: Load Helium AppArmor profile
      become: true
      ansible.builtin.command: apparmor_parser -r /etc/apparmor.d/helium-appimage

    - name: Restart ollama
      become: true
      ansible.builtin.systemd:
        name: ollama
        state: restarted
        daemon_reload: true
